# Makefile
# MENU
# Bill Waller
# billxwaller@gmail.com
#
# Makefile for the MENU application suite
#
# If you create a simpler Makefile, without increasing the size of
# executables, please share. I have created much simpler Makefiles that
# work, but only by linking all object files, which increases the size of
# the executables significantly.
#
# This Makefile produces reasonably sized executables considering the
# inclusion of debugging information and symbols.
#
# If you change -O0 to -O2, remove -g3, and add -Wl,-s to the linker,
# the executables get much smaller.
#
# ckeys       260 KB to  63 KB
# enterchr    193 KB to  14 KB
# enterstr    220 KB to  35 KB
# form        360 KB to  96 KB
# iloan        98 KB to  20 KB
# menu        433 KB to 128 KB
# pick        348 KB to  95 KB
# rsh          87 KB to  14 KB
# view        326 KB to  83 KB
# whence       81 KB to  20 KB
# total      2406 KB to 568 KB
#
# If the Child exit and signal messages from rsh are annoying,
# remove the -DVERBOSE flag from the rsh compile instruction.
# The default is to compile without -DVERBOSE.
#
CFLAGS = -O0 -g3 -std=gnu23 -fdiagnostics-color=always -Wall -Wextra \
		-Wno-unused-parameter -Wno-missing-field-initializers \
		-Wno-unused-function -DNCURSES_WIDECHAR -Wl,--gc-sections
LIBS =  -lncursesw -ltinfo
LDFLAGS = -Wl,--gc-sections
CC = gcc
TARGETS = menu form pick ckeys view whence rsh iloan enterchr enterstr

all:	$(TARGETS)
	@echo Make Complete

menu:	menu.o menu_engine.o parse_menu_desc.o init_view.o fform.o fields.o \
	pick_engine.o curskeys.o mview.o view_engine.o dwin.o futil.o init.o mem.o \
	opts.o scriou.o exec.o sig.o
	$(CC) $(CFLAGS) menu.o menu_engine.o parse_menu_desc.o init_view.o fform.o \
		fields.o pick_engine.o curskeys.o mview.o view_engine.o dwin.o futil.o \
		init.o mem.o opts.o scriou.o exec.o sig.o $(LDFLAGS) -o $@ $(LIBS)
form:	form.o fields.o fform.o mview.o init_view.o view_engine.o dwin.o futil.o \
	init.o mem.o opts.o scriou.o exec.o sig.o
	$(CC) $(CFLAGS) form.o fields.o fform.o mview.o init_view.o view_engine.o \
		dwin.o futil.o init.o mem.o opts.o scriou.o exec.o sig.o $(LDFLAGS) -o $@ \
		$(LIBS)
ckeys:	ckeys.o curskeys.o dwin.o futil.o init.o mem.o opts.o scriou.o exec.o sig.o
	$(CC) $(CFLAGS) ckeys.o curskeys.o dwin.o futil.o init.o mem.o opts.o scriou.o \
		exec.o sig.o $(LDFLAGS) -o $@ $(LIBS)
pick:	pick.o  pick_engine.o mview.o init_view.o view_engine.o dwin.o futil.o \
	init.o mem.o opts.o scriou.o exec.o sig.o
	$(CC) $(CFLAGS) pick.c  pick_engine.o mview.o init_view.o view_engine.o \
		dwin.o futil.o init.o mem.o opts.o scriou.o exec.o sig.o \
		$(LDFLAGS) -o $@ $(LIBS)
view: view.o init_view.o view_engine.o mview.o dwin.o futil.o init.o mem.o \
	opts.o scriou.o exec.o sig.o
	$(CC) $(CFLAGS) view.o init_view.o view_engine.o mview.o dwin.o futil.o \
		init.o mem.o opts.o scriou.o exec.o sig.o $(LDFLAGS) -o $@ $(LIBS)
enterchr:	enterchr.o dwin.o futil.o init.o mem.o opts.o scriou.o sig.o
	$(CC) $(CFLAGS) enterchr.o dwin.o futil.o init.o mem.o opts.o scriou.o sig.o \
		$(LDFLAGS) -o $@ $(LIBS)
enterstr:	enterstr.o dwin.o futil.o init.o mem.o opts.o scriou.o sig.o
	$(CC) $(CFLAGS) enterstr.o dwin.o futil.o init.o mem.o opts.o scriou.o sig.o \
		$(LDFLAGS) -o $@ $(LIBS)
whence:	whence.c
	$(CC) $(CFLAGS) whence.c -o $@ -lc
iloan:	iloan.c
	$(CC) $(CFLAGS) iloan.c -o $@ -lc -lm
rsh:	rsh.c
	$(CC) $(CFLAGS) rsh.c -o $@

%:	%.c menu.h
	$(CC) $(CFLAGS) $< -o $@ $(LIBS)

%.o:	%.c menu.h
	$(CC) $(CFLAGS) -c $<

clean:
	rm -rf core *.o $(TARGETS) make.out $(CFLOW_OUTPUT) *.o *.cflow \
		scan-build scan-build.log

PREFIX=~/menuapp
OWNER=bill
GROUP=users
INSTALLED=	$(PREFIX)/bin/menu $(PREFIX)/bin/form $(PREFIX)/bin/pick \
		$(PREFIX)/bin/ckeys	$(PREFIX)/bin/view $(PREFIX)/bin/whence \
		$(PREFIX)/bin/rsh $(PREFIX)/bin/ush $(PREFIX)/bin/enterchr \
		$(PREFIX)/bin/enterstr $(PREFIX)/bin/iloan

install:
	./inst.sh	--
	./inst.sh	menu		$(PREFIX)/bin	menu		0711	$(OWNER)	$(GROUP)
	./inst.sh	form		$(PREFIX)/bin	form		0711	$(OWNER)	$(GROUP)
	./inst.sh	pick		$(PREFIX)/bin	pick		0711	$(OWNER)	$(GROUP)
	./inst.sh	ckeys		$(PREFIX)/bin	ckeys		0711	$(OWNER)	$(GROUP)
	./inst.sh	view		$(PREFIX)/bin	view		0711	$(OWNER)	$(GROUP)
	./inst.sh	whence		$(PREFIX)/bin	whence		0711	$(OWNER)	$(GROUP)
	./inst.sh	rsh		$(PREFIX)/bin	rsh		4711	root	root
	./inst.sh	rsh		$(PREFIX)/bin	ush		0711	$(OWNER)	$(GROUP)
	./inst.sh	enterchr	$(PREFIX)/bin	enterchr	0711	$(OWNER)	$(GROUP)
	./inst.sh	enterstr	$(PREFIX)/bin	enterstr	0711	$(OWNER)	$(GROUP)
	./inst.sh	iloan		$(PREFIX)/bin	iloan		0711	$(OWNER)	$(GROUP)
	./inst.sh	-l
	
uninstall:
	rm -fv	$(PREFIX)/bin/menu	\
			$(PREFIX)/bin/form	\
			$(PREFIX)/bin/pick	\
			$(PREFIX)/bin/ckeys	\
			$(PREFIX)/bin/view \
			$(PREFIX)/bin/rsh \
			$(PREFIX)/bin/ush \
			$(PREFIX)/bin/enterchr \
			$(PREFIX)/bin/enterstr

