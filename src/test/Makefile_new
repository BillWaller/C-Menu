# Makefile for CMenu
# Bill Waller
# Copyright Bill Waller 2025

CC = gcc
CFLAGS = -g3 -Wall -Wextra -std=gnu23 -fPIC \
		-Wno-unused-parameter -Wno-missing-field-initializers \
		-Wno-unused-function -DNCURSES_WIDECHAR \
		-Wl,--gc-sections
#		-Wl,--as-needed
CPPFLAGS = -MMD -MP -MF deps/$(@:.o=.d) -I.
TARGETS = menu form pick view rsh enterchr enterstr ckeys iloan whence
COMMON_OBJS = curskeys.o dwin.o exec.o fform.o fields.o futil.o \
 	init.o init_view.o mem.o menu_engine.o mview.o opts.o \
 	parse_menu_desc.o pick_engine.o scriou.o sig.o view_engine.o
DEPS = $(COMMON_OBJS:.o=.d)
LIBS = -lncursesw -ltinfo -lm

.PHONY: all clean

all:	$(TARGETS)
   $(TARGETS):   $(COMMON_OBJS)

%: %.c $(COMMON_OBJS)
	$(CC) $(CFLAGS) $(CPPFLAGS) $(LIBS) $^ -o $@

%.o: %.c
	$(CC) $(CFLAGS) $(CPPFLAGS) -c $< -o $@

-include $(patsubst %.c,deps/%.d,$(wildcard *.c))

clean:
	rm -f $(TARGETS) $(TARGETS:%=%.d) $(COMMON_OBJS) $(COMMON_OBJS:.o=.d)

PREFIX=~/menuapp
OWNER=bill
GROUP=users
LIBDIR=/usr/local/lib64
LDCONF=/etc/ld.so.conf.d

install:
	./inst.sh	--
	./inst.sh	cmenu.conf	$(LDCONF) cmenu.conf	0711	root	root
	./inst.sh	libcmenu.so	$(LIBDIR) libcmenu.so	0744	root	root
	./inst.sh	menu		$(PREFIX)/bin	 menu		0711	$(OWNER)	$(GROUP)
	./inst.sh	form		$(PREFIX)/bin	 form		0711	$(OWNER)	$(GROUP)
	./inst.sh	pick		$(PREFIX)/bin	 pick		0711	$(OWNER)	$(GROUP)
	./inst.sh	ckeys		$(PREFIX)/bin	 ckeys		0711	$(OWNER)	$(GROUP)
	./inst.sh	view		$(PREFIX)/bin	 view		0711	$(OWNER)	$(GROUP)
	./inst.sh	whence		$(PREFIX)/bin	 whence		0711	$(OWNER)	$(GROUP)
	./inst.sh	rsh		$(PREFIX)/bin	 rsh		4711	root	root
	./inst.sh	rsh		$(PREFIX)/bin	 ush		0711	$(OWNER)	$(GROUP)
	./inst.sh	enterchr	$(PREFIX)/bin	 enterchr	0711	$(OWNER)	$(GROUP)
	./inst.sh	enterstr	$(PREFIX)/bin	 enterstr	0711	$(OWNER)	$(GROUP)
	./inst.sh	iloan		$(PREFIX)/bin	 iloan		0711	$(OWNER)	$(GROUP)
	./inst.sh	-l
	
uninstall:
	rm -fv	$(PREFIX)/bin/menu	\
			$(PREFIX)/bin/form	\
			$(PREFIX)/bin/pick	\
			$(PREFIX)/bin/ckeys	\
			$(PREFIX)/bin/view \
			$(PREFIX)/bin/rsh \
			$(PREFIX)/bin/enterchr \
			$(PREFIX)/bin/enterstr
